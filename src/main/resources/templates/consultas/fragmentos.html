<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    <head th:replace="~{general/fragmentos :: head}"/>

    <body>
        <!-- Advanced Search Sidebar -->
        <section th:fragment="busquedaAvanzada" class="sticky-top" style="top: 20px;">
            <div class="card shadow-sm advanced-search-card">
                <div class="card-header advanced-search-header">
                    <h5 class="mb-0">
                        <i class="fas fa-filter me-2"></i>Búsqueda Avanzada
                    </h5>
                </div>
                <div class="card-body">
                    <form method="get" th:action="@{/consultas/listado}" id="advancedSearchForm">
                        <!-- Preserve main search term -->
                        <input type="hidden" name="buscar" th:value="${buscar}">
                        
                        <!-- Category Filter - Selectable Boxes -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-tags me-1"></i>Categorías
                            </label>
                            <div class="category-checkboxes">
                                <div th:each="c : ${categorias}" class="form-check category-checkbox-item">
                                    <input class="form-check-input category-checkbox" 
                                           type="checkbox" 
                                           th:id="'cat-' + ${c.idCategoria}"
                                           th:name="categorias" 
                                           th:value="${c.idCategoria}"
                                           th:checked="${categoriasSeleccionadas != null and categoriasSeleccionadas.contains(c.idCategoria)}">
                                    <label class="form-check-label category-label" 
                                           th:for="'cat-' + ${c.idCategoria}">
                                        <span th:text="${c.descripcion}">Categoría</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Keywords Search -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-key me-1"></i>Palabras Clave
                            </label>
                            <input type="text" 
                                   name="keywords" 
                                   th:value="${keywords}"
                                   class="form-control form-control-sm" 
                                   placeholder="Ej: paracetamol, dolor, cabeza (separar con comas)">
                            <small class="form-text text-muted">Separe múltiples palabras con comas</small>
                        </div>
                        
                        <!-- Price Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-dollar-sign me-1"></i>Rango de Precio
                            </label>
                            <div class="row g-2">
                                <div class="col-6">
                                    <input type="number" 
                                           name="precioInf" 
                                           th:value="${precioInf}" 
                                           class="form-control form-control-sm" 
                                           min="0" 
                                           step="0.01"
                                           placeholder="Mínimo">
                                </div>
                                <div class="col-6">
                                    <input type="number" 
                                           name="precioSup" 
                                           th:value="${precioSup}" 
                                           class="form-control form-control-sm" 
                                           min="0" 
                                           step="0.01"
                                           placeholder="Máximo">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Location Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-map-marker-alt me-1"></i>Ubicación
                            </label>
                            <select name="ubicacion" class="form-select form-select-sm">
                                <option value="">Todas las ubicaciones</option>
                                <option value="San Jose" th:selected="${ubicacion == 'San Jose'}">San José</option>
                                <option value="Heredia" th:selected="${ubicacion == 'Heredia'}">Heredia</option>
                                <option value="Alajuela" th:selected="${ubicacion == 'Alajuela'}">Alajuela</option>
                            </select>
                        </div>
                        
                        <!-- Stock Filter -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">
                                <i class="fas fa-boxes me-1"></i>Existencias
                            </label>
                            <div class="row g-2 mb-2">
                                <div class="col-6">
                                    <input type="number" 
                                           name="existenciasMin" 
                                           th:value="${existenciasMin}" 
                                           class="form-control form-control-sm" 
                                           min="0"
                                           placeholder="Mínimo"
                                           id="stockMin">
                                </div>
                                <div class="col-6">
                                    <input type="number" 
                                           name="existenciasMax" 
                                           th:value="${existenciasMax}" 
                                           class="form-control form-control-sm" 
                                           min="0"
                                           placeholder="Máximo"
                                           id="stockMax">
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="d-grid gap-2">
                            <button type="submit" class="btn advanced-search-btn">
                                <i class="fas fa-search me-1"></i>Buscar
                            </button>
                            <a th:href="@{/consultas/listado}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-redo me-1"></i>Limpiar Filtros
                            </a>
                        </div>
                    </form>
                </div>
            </div>
        </section>

        <!-- Product Cards (removed tabs section) -->
        <section th:fragment="tarjetas" class="py-4">
            <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-4 g-4">
                <div th:each="p: ${productos}" class="col">
                    <div class="card h-100 shadow">
                        <div class="d-flex justify-content-center align-items-center bg-light p-3"
                             style="height: 200px;">
                            <img th:src="${p.rutaImagen}" class="img-fluid"
                                 style="max-height: 100%; object-fit:contain" alt="..."/>
                        </div>
                        <div class="card-header bg-white">
                            <h5 class="card-title text-center text-truncate mb-0"
                                th:text="${p.descripcion}">Titulo</h5>
                        </div>    
                        <div class="card-body d-flex flex-column">
                            <p class="card-text text-muted mb-auto text-truncate"
                               th:text="${p.detalle}">Detalle</p>
                            <small class="text-muted mt-2" th:if="${p.ubicacion}">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                <span th:text="${p.ubicacion}">Ubicación</span>
                            </small>
                        </div>
                        <div class="card-footer bg-white d-flex justify-content-between align-items-center">
                            <div class="fw-bold">
                                <span class="text-success h5" th:text="${#numbers.formatCurrency(p.precio)}">99.99</span>
                                <span th:if="${p.existencias > 0}" class="badge text-bg-success ms-2" th:text="${p.existencias} + ' unidades'">unidades</span>
                                <span th:unless="${p.existencias > 0}" class="badge text-bg-danger ms-2">Agotado</span>
                            </div>
                            <form th:action="@{/carrito/agregar}" method="post" class="d-inline">
                                <input type ="hidden" th:value="${p.idProducto}" name="idProducto">
                                    <button type="button" class="btn btn-small btn-primary"
                                            th:disabled="${p.existencias == 0}"
                                            onclick="addCart(this.form)">
                                        <i class="fas fa-cart-plus"></i>
                                    </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Empty state -->
            <div th:if="${productos == null or productos.empty}" class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <p class="text-muted">No se encontraron productos con los filtros aplicados.</p>
            </div>
        </section>

    </body>
</html>
