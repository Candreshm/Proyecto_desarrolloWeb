<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity6">
    <head th:replace="~{general/fragmentos :: head}">
        <title>Sales Overview - FarmaLife</title>
    </head>
    <body class="d-flex flex-column min-vh-100">
        <header th:replace="~{general/fragmentos :: header}"/>
        
        <main class="flex-grow-1 py-4">
            <div class="container">
                <!-- Page Header -->
                <div class="card shadow-sm admin-card mb-4">
                    <div class="card-header admin-card-header">
                        <h2 class="mb-0">
                            <i class="fas fa-chart-line me-2"></i>Sales Overview
                        </h2>
                    </div>
                </div>
                
                <!-- Charts Row -->
                <div class="row mb-4">
                    <!-- Top Selling Products Chart -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm admin-card">
                            <div class="card-header admin-card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-star me-2"></i>Top Selling Products
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="topProductsChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sales by Day Chart -->
                    <div class="col-lg-6 mb-4">
                        <div class="card shadow-sm admin-card">
                            <div class="card-header admin-card-header">
                                <h5 class="mb-0">
                                    <i class="fas fa-calendar-day me-2"></i>Sales by Day
                                </h5>
                            </div>
                            <div class="card-body">
                                <canvas id="salesByDayChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Sales Table -->
                <div class="card shadow-sm admin-card">
                    <div class="card-header admin-card-header">
                        <h4 class="mb-0">
                            <i class="fas fa-list me-2"></i>All Sales
                        </h4>
                    </div>
                    <div class="card-body p-4">
                        <div th:if="${ventas != null and !ventas.empty}">
                            <div class="table-responsive">
                                <table class="table table-hover admin-table">
                                    <thead class="admin-table-header">
                                        <tr>
                                            <th>Sale ID</th>
                                            <th>Invoice ID</th>
                                            <th>Product</th>
                                            <th>Price</th>
                                            <th>Quantity</th>
                                            <th>Subtotal</th>
                                            <th>Customer</th>
                                            <th>Date</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <tr th:each="venta : ${ventas}">
                                            <td th:text="${venta.idVenta}">1</td>
                                            <td th:text="${venta.factura.idFactura}">1</td>
                                            <td th:text="${venta.producto.descripcion}">Product</td>
                                            <td class="text-end" th:text="${#numbers.formatCurrency(venta.precioHistorico)}">₡0.00</td>
                                            <td class="text-center" th:text="${venta.cantidad}">1</td>
                                            <td class="text-end text-success fw-bold" 
                                                th:text="${#numbers.formatCurrency(venta.precioHistorico * venta.cantidad)}">₡0.00</td>
                                            <td th:text="${venta.factura.usuario.nombre + ' ' + venta.factura.usuario.apellidos}">Customer</td>
                                            <td th:text="${#temporals.format(venta.fechaCreacion, 'dd-MM-yyyy HH:mm')}">Date</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                        <div class="text-center p-5" th:if="${ventas == null or ventas.empty}">
                            <i class="fas fa-chart-line fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No sales found</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <footer th:replace="~{general/fragmentos :: footer}"/>
        
        <!-- Chart.js CDN - Load before scripts -->
        <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
        
        <!-- Data Storage for Charts using JSON in script tags -->
        <script th:inline="javascript">
            /*<![CDATA[*/
            // Top Products Data
            var topProductsData = /*[[${topProducts != null ? #lists.list(topProducts) : '[]'}]]*/ [];
            
            // Sales By Day Data  
            var salesByDayData = /*[[${salesByDay != null ? #lists.list(salesByDay) : '[]'}]]*/ [];
            /*]]>*/
        </script>
        
        <!-- Chart Initialization Script -->
        <script>
            // Wait for Chart.js to load and DOM to be ready
            function initializeCharts() {
                // Check if Chart is available
                if (typeof Chart === 'undefined') {
                    console.error('Chart.js is not loaded!');
                    setTimeout(initializeCharts, 100); // Retry after 100ms
                    return;
                }
                
                console.log('Chart.js loaded, initializing charts...');
                console.log('Top Products Data:', topProductsData);
                console.log('Sales By Day Data:', salesByDayData);
                
                // Top Selling Products Chart
                var topProductsCanvas = document.getElementById('topProductsChart');
                if (topProductsCanvas && topProductsData && topProductsData.length > 0) {
                    try {
                        // Convert Thymeleaf data structure to chart format
                        var labels = [];
                        var quantities = [];
                        
                        for (var i = 0; i < topProductsData.length; i++) {
                            var product = topProductsData[i];
                            // Handle both Map and object formats
                            var name = product.name || product['name'] || '';
                            var quantity = product.quantity || product['quantity'] || 0;
                            
                            if (name) {
                                labels.push(name);
                                quantities.push(parseInt(quantity) || 0);
                            }
                        }
                        
                        console.log('Top Products Labels:', labels);
                        console.log('Top Products Quantities:', quantities);
                        
                        if (labels.length > 0) {
                            new Chart(topProductsCanvas.getContext('2d'), {
                                type: 'bar',
                                data: {
                                    labels: labels,
                                    datasets: [{
                                        label: 'Quantity Sold',
                                        data: quantities,
                                        backgroundColor: 'rgba(76, 175, 80, 0.7)',
                                        borderColor: 'rgba(76, 175, 80, 1)',
                                        borderWidth: 2
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: true,
                                            position: 'top'
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                stepSize: 1
                                            }
                                        }
                                    }
                                }
                            });
                            console.log('Top Products Chart created successfully');
                        } else {
                            topProductsCanvas.parentElement.innerHTML = 
                                '<p class="text-center text-muted p-4"><i class="fas fa-info-circle me-2"></i>No product data available</p>';
                        }
                    } catch (error) {
                        console.error('Error creating top products chart:', error);
                        topProductsCanvas.parentElement.innerHTML = 
                            '<p class="text-center text-danger p-4"><i class="fas fa-exclamation-triangle me-2"></i>Error loading chart</p>';
                    }
                } else if (topProductsCanvas) {
                    topProductsCanvas.parentElement.innerHTML = 
                        '<p class="text-center text-muted p-4"><i class="fas fa-info-circle me-2"></i>No sales data available</p>';
                }
                
                // Sales by Day Chart
                var salesByDayCanvas = document.getElementById('salesByDayChart');
                if (salesByDayCanvas && salesByDayData && salesByDayData.length > 0) {
                    try {
                        var dateLabels = [];
                        var counts = [];
                        
                        for (var i = 0; i < salesByDayData.length; i++) {
                            var sale = salesByDayData[i];
                            var dateStr = sale.date || sale['date'] || '';
                            var count = sale.count || sale['count'] || 0;
                            
                            if (dateStr) {
                                // Parse date (format: YYYY-MM-DD)
                                var parts = dateStr.split('-');
                                if (parts.length === 3) {
                                    var date = new Date(parts[0], parts[1] - 1, parts[2]);
                                    dateLabels.push(date.toLocaleDateString('es-CR', { day: '2-digit', month: '2-digit' }));
                                } else {
                                    dateLabels.push(dateStr);
                                }
                                counts.push(parseInt(count) || 0);
                            }
                        }
                        
                        console.log('Sales By Day Labels:', dateLabels);
                        console.log('Sales By Day Counts:', counts);
                        
                        if (dateLabels.length > 0) {
                            new Chart(salesByDayCanvas.getContext('2d'), {
                                type: 'line',
                                data: {
                                    labels: dateLabels,
                                    datasets: [{
                                        label: 'Number of Sales',
                                        data: counts,
                                        backgroundColor: 'rgba(76, 175, 80, 0.2)',
                                        borderColor: 'rgba(76, 175, 80, 1)',
                                        borderWidth: 3,
                                        fill: true,
                                        tension: 0.4
                                    }]
                                },
                                options: {
                                    responsive: true,
                                    maintainAspectRatio: false,
                                    plugins: {
                                        legend: {
                                            display: true,
                                            position: 'top'
                                        }
                                    },
                                    scales: {
                                        y: {
                                            beginAtZero: true,
                                            ticks: {
                                                stepSize: 1
                                            }
                                        }
                                    }
                                }
                            });
                            console.log('Sales By Day Chart created successfully');
                        } else {
                            salesByDayCanvas.parentElement.innerHTML = 
                                '<p class="text-center text-muted p-4"><i class="fas fa-info-circle me-2"></i>No date data available</p>';
                        }
                    } catch (error) {
                        console.error('Error creating sales by day chart:', error);
                        salesByDayCanvas.parentElement.innerHTML = 
                            '<p class="text-center text-danger p-4"><i class="fas fa-exclamation-triangle me-2"></i>Error loading chart</p>';
                    }
                } else if (salesByDayCanvas) {
                    salesByDayCanvas.parentElement.innerHTML = 
                        '<p class="text-center text-muted p-4"><i class="fas fa-info-circle me-2"></i>No sales data available</p>';
                }
            }
            
            // Initialize when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initializeCharts);
            } else {
                // DOM is already ready
                initializeCharts();
            }
        </script>
    </body>
</html>
